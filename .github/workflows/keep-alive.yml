name: Keep Supabase Active (Enhanced)

on:
  schedule:
    # Run every 2 days at 3:00 AM UTC to prevent 7-day auto-pause
    # More frequent than the original 3-day schedule for better reliability
    - cron: '0 3 */2 * *'

  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest

    steps:
    - name: Enhanced Supabase Database Activity
      continue-on-error: true  # Continue even if some tests fail
      run: |
        set +e  # Don't exit on errors, handle them gracefully
        echo "ğŸ“ Enhanced Supabase keep-alive starting..."
        echo "ğŸ“… Run time: $(date -u)"
        echo "ğŸ”„ Frequency: Every 2 days"
        echo "ğŸ¯ Purpose: Prevent 7-day auto-pause on free tier"
        echo ""

        # Test 1: Basic API connectivity
        echo "ğŸŒ Testing API connectivity..."
        api_response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 \
          -H "apikey: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" \
          "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}/rest/v1/" 2>/dev/null || echo "000")

        echo "API Response: $api_response"

        if [ "$api_response" -eq 401 ]; then
          echo "âœ… API responding (401 expected without specific table access)"
        elif [ "$api_response" -eq 200 ]; then
          echo "âœ… API responding successfully"
        else
          echo "âš ï¸ Unexpected API response: $api_response"
        fi
        echo ""

        # Test 2: Actual database query - Count users (this creates real DB activity)
        echo "ğŸ—„ï¸ Testing database activity with actual query..."
        users_response=$(curl -s -w "%{http_code}" --max-time 30 \
          -H "apikey: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" \
          "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}/rest/v1/users?select=count" \
          -o /tmp/users_response.txt 2>/dev/null || echo "000")

        users_code=$(echo "$users_response" | tail -c 4)
        echo "Users query response: $users_code"

        # Test 3: Check strengths table (reference data)
        echo "ğŸ“Š Testing strengths table access..."
        strengths_response=$(curl -s -w "%{http_code}" --max-time 30 \
          -H "apikey: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" \
          "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}/rest/v1/strengths?select=count&limit=1" \
          -o /tmp/strengths_response.txt 2>/dev/null || echo "000")

        strengths_code=$(echo "$strengths_response" | tail -c 4)
        echo "Strengths query response: $strengths_code"

        # Test 4: Check email logs table (shows system is active)
        echo "ğŸ“§ Testing email logs table..."
        logs_response=$(curl -s -w "%{http_code}" --max-time 30 \
          -H "apikey: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" \
          -H "Authorization: Bearer ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" \
          "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}/rest/v1/email_logs?select=count&limit=1" \
          -o /tmp/logs_response.txt 2>/dev/null || echo "000")

        logs_code=$(echo "$logs_response" | tail -c 4)
        echo "Email logs query response: $logs_code"
        echo ""

        # Summary
        echo "ğŸ“‹ Database Activity Summary:"
        echo "   â€¢ API connectivity: $api_response"
        echo "   â€¢ Users table query: $users_code"
        echo "   â€¢ Strengths table query: $strengths_code"
        echo "   â€¢ Email logs query: $logs_code"
        echo ""

        # Success criteria - check each response safely
        success_count=0

        # Check API response
        if [[ "$api_response" =~ ^[0-9]+$ ]] && ([ "$api_response" -eq 200 ] || [ "$api_response" -eq 401 ]); then
          success_count=$((success_count + 1))
          echo "âœ… API test passed"
        else
          echo "âŒ API test failed (response: $api_response)"
        fi

        # Check users table
        if [[ "$users_code" =~ ^[0-9]+$ ]] && ([ "$users_code" -eq 200 ] || [ "$users_code" -eq 401 ] || [ "$users_code" -eq 403 ]); then
          success_count=$((success_count + 1))
          echo "âœ… Users table test passed"
        else
          echo "âŒ Users table test failed (response: $users_code)"
        fi

        # Check strengths table
        if [[ "$strengths_code" =~ ^[0-9]+$ ]] && ([ "$strengths_code" -eq 200 ] || [ "$strengths_code" -eq 401 ] || [ "$strengths_code" -eq 403 ]); then
          success_count=$((success_count + 1))
          echo "âœ… Strengths table test passed"
        else
          echo "âŒ Strengths table test failed (response: $strengths_code)"
        fi

        # Check logs table
        if [[ "$logs_code" =~ ^[0-9]+$ ]] && ([ "$logs_code" -eq 200 ] || [ "$logs_code" -eq 401 ] || [ "$logs_code" -eq 403 ]); then
          success_count=$((success_count + 1))
          echo "âœ… Email logs test passed"
        else
          echo "âŒ Email logs test failed (response: $logs_code)"
        fi

        echo ""
        echo "âœ… Successful connections: $success_count/4"

        if [ "$success_count" -ge 1 ]; then
          echo "âœ… Keep-alive successful: Some database activity registered"
          echo "ğŸ›¡ï¸ Supabase project will remain active"
          exit 0
        else
          echo "âš ï¸ Warning: No successful database connections"
          echo "ğŸ“ Manual check may be needed"
          exit 0  # Don't fail the workflow completely
        fi

    - name: Ping Production Application
      continue-on-error: true
      run: |
        echo ""
        echo "ğŸŒ Testing production application..."

        # Ping the actual production URL
        if [ -n "${{ secrets.PRODUCTION_URL }}" ]; then
          app_response=$(curl -s -o /dev/null -w "%{http_code}" \
            "${{ secrets.PRODUCTION_URL }}")
          echo "Production app response: $app_response"

          if [ "$app_response" -eq 200 ]; then
            echo "âœ… Production application is healthy"
          else
            echo "âš ï¸ Production app returned: $app_response"
          fi
        else
          # Use known production URL
          app_response=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://stronger.tinymanager.ai")
          echo "App response: $app_response"

          if [ "$app_response" -eq 200 ]; then
            echo "âœ… Application is responding"
          else
            echo "âš ï¸ Application returned: $app_response"
          fi
        fi

    - name: Summary Report
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ¯ ENHANCED KEEP-ALIVE COMPLETE"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“… Completed: $(date -u)"
        echo "â° Next run: In 2 days"
        echo "ğŸ”„ Schedule: Every 2 days at 3:00 AM UTC"
        echo "ğŸ›¡ï¸ Protection: Against 7-day Supabase auto-pause"
        echo "ğŸ“Š Method: Multiple database queries for real activity"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"